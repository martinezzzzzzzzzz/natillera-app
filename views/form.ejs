<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Natifamily</title>

    <!-- Favicon para la pestaña -->
    <link rel="icon" type="image/png" href="/logo_new.png">

    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
            position: relative;
        }

        h1 { text-align: center; }

        form { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            max-width: 500px; 
            margin: 40px auto 0 auto; 
        }

        label { display: block; margin-top: 15px; font-weight: bold; }
        input { width: 100%; padding: 8px; font-size: 14px; margin-top: 5px; box-sizing: border-box; }
        button { margin-top: 20px; padding: 10px 15px; font-size: 16px; cursor: pointer; background: #e53935; color: #fff; border: none; border-radius: 4px; }
        #recalcularBtn { background: #1565c0; display: none; }

        .autocomplete-container { position: relative; width: 100%; }
        #buscadorSocio { width: 100%; padding: 10px; font-size: 14px; }
        .lista-socios {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc;
            max-height: 200px; overflow-y: auto;
            display: none; z-index: 2000;
        }
        .lista-item { padding: 10px; cursor: pointer; }
        .lista-item:hover { background: #eee; }

        /* Logo flotante arriba a la derecha en el body */
        .logo-float {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 80px;
            height: auto;
            z-index: 1000;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
</head>
<body>

    <!-- Logo flotante arriba a la derecha -->
    <img src="/logo_new.png" alt="Logo" class="logo-float">

    <h1>Generar Liquidación </h1>

    <form action="/generar" method="POST">
        <label>Seleccionar socio:</label>
        <div class="autocomplete-container">
            <input type="text" id="buscadorSocio" placeholder="Buscar por nombre o ID...">
            <div id="listaSocios" class="lista-socios"></div>
        </div>

        <input type="hidden" name="socio" id="socioID">

        <label>Aporte mensual:</label>
        <input type="text" name="aporte_mensual" id="aporte-mensual" class="money-input" required>

        <label>Total aportes y viernes:</label>
        <input type="text" name="total_aportes" class="money-input" required>

        <label>Intereses financieros:</label>
        <input type="text" name="intereses" class="money-input" required>

        <label>Actividades:</label>
        <input type="text" name="actividades" class="money-input" required>

        <label>Administración:</label>
        <input type="text" value="-30.000,00" id="administracion" class="money-input" disabled>

        <label>Total final:</label>
        <input type="text" name="total_final" class="money-input" required>

        <button type="button" id="recalcularBtn">Recalcular total</button>
        <button type="submit">Generar PDF</button>
    </form>

<script>
    const socios = <%- JSON.stringify(socios) %>;

    const buscador = document.getElementById("buscadorSocio");
    const lista = document.getElementById("listaSocios");
    const idSocio = document.getElementById("socioID");

    const aporteInput = document.getElementById("aporte-mensual");
    const totalAportesInput = document.querySelector('input[name="total_aportes"]');
    const interesesInput = document.querySelector('input[name="intereses"]');
    const actividadesInput = document.querySelector('input[name="actividades"]');
    const adminInput = document.getElementById("administracion");
    const totalFinalInput = document.querySelector('input[name="total_final"]');

    const btnRecalcular = document.getElementById("recalcularBtn");

    function convertirAValorNumerico(valorFormateado) {
        if (!valorFormateado) return 0;
        valorFormateado = valorFormateado.replace(/\./g, '');
        valorFormateado = valorFormateado.replace(/,/g, '.');
        return parseFloat(valorFormateado) || 0;
    }

    function formatear(num) {
        return new Intl.NumberFormat("es-CO", { minimumFractionDigits: 2 }).format(num);
    }

    function mostrarListaCompleta() {
        lista.innerHTML = "";
        socios.forEach(s => agregarItem(s));
        lista.style.display = "block";
    }

    function filtrar() {
        const texto = buscador.value.toLowerCase();
        lista.innerHTML = "";
        const filtrados = socios.filter(s =>
            s.Nombre.toLowerCase().includes(texto) ||
            s.ID.toString().includes(texto)
        );
        filtrados.forEach(s => agregarItem(s));
        lista.style.display = filtrados.length ? "block" : "none";
    }

    function agregarItem(socio) {
        const item = document.createElement("div");
        item.classList.add("lista-item");
        item.textContent = `${socio.ID} - ${socio.Nombre}`;
        item.addEventListener("click", () => seleccionar(socio));
        lista.appendChild(item);
    }

    function seleccionar(socio) {
        buscador.value = `${socio.ID} - ${socio.Nombre}`;
        idSocio.value = socio.ID;

        let aporte = socio.AporteMensual.replace(/\$/g, '').trim();
        aporte = convertirAValorNumerico(aporte);

        aporteInput.value = formatear(aporte);

        calcularValores(aporte);

        lista.style.display = "none";
    }

    function calcularValores(aporte) {
        const viernes = 52000;
        const interesesFijos = 59000;
        const actividades = 0;
        const administracion = 30000;

        const totalAportes = aporte * 12 + viernes;
        const totalFinal = totalAportes + interesesFijos - administracion;

        totalAportesInput.value = formatear(totalAportes);
        interesesInput.value = formatear(interesesFijos);
        actividadesInput.value = formatear(actividades);
        totalFinalInput.value = formatear(totalFinal);

        btnRecalcular.style.display = "none";
    }

    function recalcularConCambios() {
        const aporte = convertirAValorNumerico(aporteInput.value);
        const totalAportes = convertirAValorNumerico(totalAportesInput.value);
        const intereses = convertirAValorNumerico(interesesInput.value);
        const actividades = convertirAValorNumerico(actividadesInput.value);
        const admin = convertirAValorNumerico(adminInput.value);

        const totalFinal = totalAportes + intereses + actividades + admin;

        totalFinalInput.value = formatear(totalFinal);
    }

    function activarBotonRecalcular() {
        btnRecalcular.style.display = "block";
    }

    [aporteInput, totalAportesInput, interesesInput, actividadesInput]
        .forEach(campo => campo.addEventListener("input", activarBotonRecalcular));

    btnRecalcular.addEventListener("click", recalcularConCambios);

    buscador.addEventListener("focus", mostrarListaCompleta);
    buscador.addEventListener("input", filtrar);

    document.addEventListener("click", e => {
        if (!e.target.closest(".autocomplete-container")) {
            lista.style.display = "none";
        }
    });

    document.querySelectorAll('.money-input').forEach(input => {
        new Cleave(input, {
            numeral: true,
            numeralThousandsGroupStyle: 'thousand',
            numeralDecimalMark: ',',
            delimiter: '.',
            numeralDecimalScale: 2
        });
    });
</script>

</body>
</html>
